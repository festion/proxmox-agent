#!/bin/bash
# Proxmox Root Filesystem Safe Cleanup Script
# Generated by Proxmox Agent

echo "üßπ Starting Proxmox Root Filesystem Cleanup..."
echo "================================================"

# Function to show disk space before/after
show_space() {
    echo "üìä Current disk space:"
    df -h / | grep -v Filesystem
    echo ""
}

echo "üìä BEFORE CLEANUP:"
show_space

# 1. Clean system logs (SAFE)
echo "üóëÔ∏è  Cleaning system logs..."
journalctl --vacuum-time=7d
find /var/log -type f -name '*.log.*' -mtime +7 -delete 2>/dev/null
find /var/log -type f -name '*.gz' -mtime +14 -delete 2>/dev/null
echo "‚úÖ System logs cleaned"

echo ""
show_space

# 2. Clean package cache (SAFE)
echo "üóëÔ∏è  Cleaning package cache..."
apt clean
apt autoclean
apt autoremove -y
echo "‚úÖ Package cache cleaned"

echo ""
show_space

# 3. Clean temporary files (SAFE)
echo "üóëÔ∏è  Cleaning temporary files..."
find /tmp -type f -mtime +7 -delete 2>/dev/null
find /var/tmp -type f -mtime +7 -delete 2>/dev/null
echo "‚úÖ Temporary files cleaned"

echo ""
show_space

# 4. Clean core dumps (SAFE)
echo "üóëÔ∏è  Cleaning core dumps..."
find / -name 'core.*' -delete 2>/dev/null
find / -name '*.core' -delete 2>/dev/null
echo "‚úÖ Core dumps cleaned"

echo ""
show_space

# 5. Proxmox log cleanup (MEDIUM RISK - review first)
echo "‚ö†Ô∏è  Proxmox log cleanup (review recommended)..."
echo "   To clean Proxmox logs manually, run:"
echo "   find /var/log/pve* -type f -mtime +30 -delete"
echo "   logrotate -f /etc/logrotate.conf"

# 6. Old kernel cleanup (MEDIUM RISK - review first)
echo "‚ö†Ô∏è  Old kernel cleanup (review recommended)..."
echo "   Current kernels installed:"
dpkg --list | grep linux-image | grep -v meta
echo ""
echo "   To remove old kernels, run: apt autoremove --purge"

echo ""
echo "üìä FINAL DISK SPACE:"
show_space

echo ""
echo "üéâ Safe cleanup completed!"
echo "‚ö†Ô∏è  For additional space recovery, review the medium-risk items above"
